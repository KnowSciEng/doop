.decl VPTCountPerMethod(?method:Method, ?n:number)

VPTCountPerMethod(?method, Y) :-
   isVar(?var),
   Var_DeclaringMethod(?var, ?method),
   Y =  count : {mainAnalysis.VarPointsTo(?hctx, ?value, ?ctx, ?var),
   ?hctx = ?hctx,
   ?ctx = ?ctx,
   ?value = ?value}.

.decl CalleeCountPerMethod(?method:Method, ?n:number)

CalleeCountPerMethod(?method, Y) :-
  isMethod(?method),
  Y =  count : {mainAnalysis.CallGraphEdge(_, ?invo, _, ?tomethod),
  Instruction_Method(?invo, ?method),
  ?tomethod = ?tomethod}.

.decl CallerCountPerMethod(?method:Method, ?n:number)

CallerCountPerMethod(?tomethod, Y) :-
  isMethod(?tomethod),
  Y =  count : {mainAnalysis.CallGraphEdge(_, ?invo, _, ?tomethod),
  Instruction_Method(?invo, _)}.
                             
.decl NeighboringMethodsInCallGraph(?method:Method, ?neighbor:Method, ?weight:number)

NeighboringMethodsInCallGraph(?method, ?method, 1) :-
   VPTCountPerMethod(?method, _).

NeighboringMethodsInCallGraph(?method, ?neigh, ?weight) :-
  mainAnalysis.CallGraphEdge(_, ?invo, _, ?method),
  Instruction_Method(?invo, ?neigh),
  CalleeCountPerMethod(?neigh, ?weight).

NeighboringMethodsInCallGraph(?neigh, ?method, ?weight) :-
  mainAnalysis.CallGraphEdge(_, ?invo, _, ?neigh),
  Instruction_Method(?invo, ?method),
  CallerCountPerMethod(?neigh, ?weight).
                     
// .decl TwoLevelCallerMethodInCallGraph(?neighbor:Method, ?method:Method, ?weight:number)

// TwoLevelCallerMethodInCallGraph(?neigh, ?method, ?weight) :-
//   NeighboringMethodsInCallGraph(?intermediatemethod, ?method, _),
//   mainAnalysis.CallGraphEdge(_, ?invo, _, ?intermediatemethod),
//   Instruction_Method(?invo, ?neigh),
//   CalleeCountPerMethod(?neigh, ?weight).

// TwoLevelCallerMethodInCallGraph(?neigh, ?method, ?weight) :-
//    NeighboringMethodsInCallGraph(?neigh, ?method, ?weight).

.decl WeightedLocalVPTSize(?method:Method, ?n:number)
      
WeightedLocalVPTSize(?method, Y) :-
  isMethod(?method),
  Y = sum ?n * 100 / ?weight: { NeighboringMethodsInCallGraph(?neigh, ?method, ?weight), VPTCountPerMethod(?neigh, ?n) }.

.decl LocalIFPTSize(?method:Method, ?n:number)

LocalIFPTSize(?method, Y) :-
  isMethod(?method),
  Y = count : {Var_DeclaringMethod(?var, ?method),
  mainAnalysis.VarPointsTo(_, ?basevalue, _, ?var),
  mainAnalysis.InstanceFieldPointsTo(_, ?value, _, _, ?basevalue)}.  

.decl MethodWeight(?method:Method, ?n:number)

MethodWeight(?method, ?n) :-      
  WeightLocalVPTSize(?method, ?size1),
  LocalIFPTSize(?method, ?size2),
  ?n = ?size1 + ?size2.

.output WeightedLocalVPTSize
.output LocalIFPTSize
.output MethodWeight
